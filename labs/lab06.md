# Lab 06 - Continuous Testing

On this lab you'll add an additional step to perform E2E testing on your Todo App

## Learning Objectives

In this lab, you will learn how to:

- Add a new step to your pipeline to perform E2E testing
- Learn how to share data between jobs
- Brief introduction to Playwright

## Instructions

- [Add E2E scripts](#add-e2e-scripts)
- [Update GitHub workflows](#update-github-workflows)
- [Run your pipelines](#run-your-pipelines)

## Add E2E scripts

As always, you need to udpate your repo and create a new branch to make the changes.

```bash
git checkout main
git pull
git checkout -b add-e2e-tests
```

Now, download the files available [here](https://1drv.ms/u/s!AuiYWSaxdaYvlZIqz_WHB0BEMQyKiA?e=wTXhIm) and unzip it on the folder `src/TodoWebapp`.

The added files are:

- `package.json` and `package-lock.json`: Contains the dependencies to run the E2E tests
- `playwright.config.js`: Contains the configuration to run the E2E tests
- `tests` folder: Contains the E2E tests

These tests were written using Playwright, a library to automate Chromium, Firefox and WebKit with a single API. You can learn more about Playwright [here](https://playwright.dev/).

On this sample, you may check how to define this tests using TypeScript but you can use other languages and other testing frameworks, like xUnit.

If you want to know more about Playwright, you can check the [Playwright Getting Start](https://playwright.dev/docs/intro).

## Update GitHub workflows

On this lab, you will only update Todo Webapp pipelines, since the E2E tests were created to use the web frontend to make the tests.

Edit `todo-webapp.yml` and start to add a new stage on your workflow, after `stg` stage and before `prod` stage:

```yaml
  test-stg:
    needs: stg
    timeout-minutes: 60
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./src/TodoWebapp

    steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: 16
    
    - name: Install dependencies
      run: npm ci
    - name: Install Playwright Browsers
      run: npx playwright install --with-deps
    
    - name: Run Playwright tests
      run: npx playwright test
      env:
        BASE_URL: ${{ needs.stg.outputs.webapp-url }}
    
    - uses: actions/upload-artifact@v3
      if: always()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 30
```

On this stage, you can find new features from GitHub Actions.

```yaml
  defaults:
      run:
        working-directory: ./src/TodoWebapp
```

This block allows you to define a default working directory for all steps on this stage. This way, you don't need to define the working directory on each step.

Then, you use an output from a job (not a step) on this stage:

```yaml
- name: Run Playwright tests
  run: npx playwright test
    env:
      BASE_URL: ${{ needs.stg.outputs.webapp-url }}
```

On this line, `BASE_URL: ${{ needs.stg.outputs.webapp-url }}` you're setting a environment variable named `BASE_URL` with the value of the output variable `webapp-url` from the job `stg` that is accessed using the variable `needs`.

To make this stage run properly, you need top make two additional changes your pipeline.

First, you must change the sequence on how this stages run so you need to go to `prod` stage and find the following line:

```yaml
needs: stg
```

And change it to:

```yaml
needs: test-stg
```

Finally, you need to set the `webapp-url` output variable on the `stg` stage. To do that, you need to add the following line to the `stg` stage, at same indentation level of `needs` property:

```yaml
outputs:
  webapp-url: ${{ steps.stg-deploy.outputs.webapp-url }}
```

## Run your pipelines

To run your pipelines, you already know the flow: commit your changes, push to GitHub, create a pull request and merge it.

After your pipeline run until the end (meaning deploy to production) you may check the artifacts produced by your pipeline to get the details generated by Playwright.

To get access to the artifacts, go to Actions tab, select the last run of your pipeline and click on `playwright-report` artifact at the end of the page.
